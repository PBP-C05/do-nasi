{% extends 'base.html' %}

{% block meta %}
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.js" integrity="sha512-n/4gHW3atM3QqRcbCn6ewmpxcLAHGaDjpEBu4xZd47N0W2oQ+6q7oc3PXstrJYXcbNU1OHdQ1T7pAP+gi5Yu8g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
{% endblock meta %}

{% block content %}
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8" crossorigin="anonymous"></script>

  <script>
    function showData(){
      $.get("./json/all-posts", function(item){
        for(let i=0; i<item.length; i++) {
          putPost(item[i]);
          replyPost(item[i]);
        }
      })
    }

    function putPost(post){
      let user_username = JSON.parse(document.getElementById('user_username').textContent);
      let deleteOption = (user_username === post.fields.user.username)
                        ?`<a id="delete-post-${post.pk}" href="delete-post/${post.pk}">
                            <small>delete post</small>
                          </a>` 
                        : ''

      $("#posts").prepend(
        `\n<div class="flex-grow-1 py-2 my-4 mx-3 card">
          <div id="post-${post.pk}">
            <div class="card-body px-4 pt-3 pb-3">
              <div>
                <h6>${post.fields.user.name} <small class="text-muted"><i>  —  ${post.fields.user.role}</i></small></h6>
              </div>
              <h3 class="card-title pt-2">
                ${post.fields.title}<br>
                <small class="date-info text-muted">${post.fields.date}</small>
              </h3>
              <p class="card-text pt-2">${post.fields.body}</p>
            </div>
          
            <div class="px-4">
              <a data-bs-toggle="collapse" href="#comment-post-${post.pk}" role="button" aria-expanded="false">
                <small>see all replies</small>
              </a>

              {% if request.user.is_authenticated %}
                <a data-bs-toggle="collapse" href="#reply-${post.pk}" role="button" aria-expanded="false" aria-controls="collapseExample">
                  <small>reply</small>
                </a>

                ${deleteOption}
              {% endif %}
            </div>

            <div class="collapse mt-2 mx-4" id="reply-${post.pk}">
              <form method="POST" id="add-comment-${post.pk}">
                {% csrf_token %}
                <textarea type="text" name="comment-body-${post.pk}" id="comment-body-${post.pk}" class="form-control" required></textarea>
                <button class="btn btn-dark" type="submit" style="margin-top: 10px"> add comment </button>
              </form>
            </div>
          </div>

          <div id="comment-post-${post.pk}" class="collapse">
            <!--- comment replies will be appended through ajax --->
          </div>
        </div>`
      );
      
      $.get(`./json/all-comments/${post.pk}`, function(comments){
        for(let j=0; j<comments.length; j++){
          putReplies(comments[j]);
          deleteReply(comments[j]);
        }
      })
    }

    function putReplies(comment){
      let user_username = JSON.parse(document.getElementById('user_username').textContent);
      let deleteOption = (user_username === comment.fields.user.username)
                        ?`<a id="delete-comment-${comment.pk}" href="delete-comment/${comment.pk}")">
                            <small>delete comment</small>
                          </a>` 
                        : ''
      $(`#comment-post-${comment.fields.post}`).append(
        `<div class="d-flex card-body mt-2 px-3 pt-3 border-top" id="comment-${comment.pk}">
          <div class="mx-4">
            <small>${comment.fields.user.name} <small class="text-muted"><i>  —  ${comment.fields.user.role}</i></small></small>
            <p class="pt-2">${comment.fields.body}</p>
          </div>
        </div>
        <div class="mx-4 px-3">
          ${deleteOption}
        </div>`
      );
    }

    function replyPost(post){
      $(`#add-comment-${post.pk}`).submit(function(event){
        event.preventDefault();
        $.post(`add-comment/${post.pk}`, {
          body : $(`#comment-body-${post.pk}`).val()
        }).done(function(data){
          // action on form
          $(`#add-comment-${post.pk}`)[0].reset();
          $(`#add-comment-${post.pk}`).collapse('hide');
         
          // putting the reply
          putReplies(data);
         
          // redirect to comment
          $(`#comment-post-${post.pk}`).collapse('show');
          location.href = "#";
          location.href = `#comment-${data.pk}`;
        })
      })
    }

    function deletePost(post){
      $(`#delete-post-${post.pk}`).click(function(){
        $(`post-${post.pk}`).fadeOut();
      })
    }

    function deleteReply(comment){
      $('#onDelete').append(
        `\n<div class="d-flex card-body mt-2 px-3 pt-3 border-top" id="comment-${comment.pk}">
          <div class="mx-4">
            <small>${comment.fields.user.name} <small class="text-muted"><i>  —  ${comment.fields.user.role}</i></small></small>
            <p class="pt-2">${comment.fields.body}</p>
          </div>
        </div>\n`
      )
    }

    function addPost(){
      $.post("{% url 'questions:add_post' %}", {
        title : $("#title").val(),
        body  : $("#body").val(),
      }).done(function(data){
        // action on form
        $("#add-post")[0].reset();
        
        // putting the post
        putPost(data);
        
        // redirect to post
        location.href = "#";
        location.href = `#post-${data.pk}`;
      })
    }

    $(document).ready(function(){
      showData();

      $(`#add-post`).submit(function(event){
        event.preventDefault();
        addPost();
      });
    }) 

    // <!-- ajax setup below is for csrf -->
    $.ajaxSetup({ 
      beforeSend: function(xhr, settings) {
        function getCookie(name) {
          var cookieValue = null;
          if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
              var cookie = jQuery.trim(cookies[i]);
              // Does this cookie string begin with the name we want?
              if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
              }
            }
          }
          return cookieValue;
        }
        if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
          // Only send the token to relative URLs i.e. locally.
          xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
        }
      } 
    });
  </script>

  <style>
    a:link {
      text-decoration: none;
    }
    a:visited {
      text-decoration: none;
    }
    .jumbotron{
      text-align: center;
      background-color: rgba(217,217,217,0.75);
    }
    .header-section{
      height: calc(50vh - 50px);
      overflow: hidden;
      position: relative;
      color: #fff;
    }
    .header-section img{
      position: absolute;
      left: 0;
      bottom: 0;
      opacity: 0.45;
      width: 100%;
      height: 50vh;
      overflow: hidden;
      object-fit: cover;
      z-index: -1;
    }
    .header-section h1{
      font-weight: 700;
      font-size: 3.75rem;
      margin: 0;
      position: absolute;
      top: 65%;
      left: 50%;
      -ms-transform: translate(-50%, -50%);
      transform: translate(-50%, -50%);
    }
    .date-info{
      font-size: 12px;
    }
    .big-title{
      font-size: 2.75rem;
    }
    .form-group{
      margin-top: 16px;
    }
    @media only screen and (min-width: 992px) {
      #add-post{
        width: 70%;
      }
    }
  </style>

  <div class="header-section">
    <img src="https://lingkarjatim.com/wp-content/uploads/2020/04/IMG-20200420-WA0046-1024x768.jpg">
    <h1>Discussion</h1>
  </div>

  

  <div class="container">
    <div class="row justify-content-sm-center my-5 px-10">
      <div class="col-md-2">
        <i class="bi bi-chat-right-text-fill text-warning" style="font-size:8vw"></i>
      </div>
      <div class="col-lg-8 my-auto">
        <div class="big-title">We hear you!</div>
        <p>
        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer a metus fringilla, fermentum enim sed, pellentesque mauris. 
        Donec tristique convallis massa non pulvinar. Pellentesque vel suscipit lacus. Phasellus bibendum turpis et leo tempor, ut tempor nulla venenatis. 
        Ut dignissim consectetur tristique. Pellentesque aliquet turpis ut nisi rutrum, eget volutpat magna euismod. 
        Aenean mollis semper lorem, eu viverra ex ultricies quis. Nunc vel enim leo.
        </p>
      </div>
    </div>

      {% if not request.user.is_authenticated %}
      <div class="jumbotron mt-4 p-3">
        <a href="">Login</a> to post a new discussion<br>
        <small>Don't have an account yet? <a href="">Register</a> now!</small>
      </div>
      {% else %}
      <!-- Form for putting a post -->
      <form method="POST" id="add-post" class="mx-3">
        <h2>Post a Discussion</h2>
        {% csrf_token %}
        <div class="form-group">
          <label>Title</label>
          <input type="text" name="title" id="title" class="form-control" required>
        </div>

        <div class="form-group">
          <label>Body</label>
          <textarea rows="3" cols="70" name="body"  id="body" class="form-control" required></textarea>
        </div>

        <button class="btn btn-dark" type="submit" style="margin-top: 10px"> add post </button>
      </form> 
      {% endif %}

    <div id="posts">
        <!-- A post and comments will be appended through ajax -->
    </div>
  </div>

  <h2>Frequently Asked Questions</h2>
  <div class="row">
    {% for q in faq %}
      <div class="card-header">
        <a class="btn btn-block text-left" data-bs-toggle="collapse" href="#FAQ-{{q.id}}" role="button" aria-expanded="false" aria-controls="collapseExample">
          {{q.question}}
        </a>
      </div>
      <div class="collapse" id="FAQ-{{q.id}}">
        <div class="card-body">
          <p>{{q.answer}}</p>
        </div>
      </div>     
    {% endfor %}
  </div>
  {{ request.user.username|json_script:"user_username" }}
{% endblock content %}